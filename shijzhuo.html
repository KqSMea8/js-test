<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        .upload_box{width:800px; margin:1em auto;}
        .upload_main{border-width:1px 1px 2px; border-style:solid; border-color:#ccc #ccc #ddd; background-color:#fbfbfb;}
        .upload_choose{padding:1em;}
        .upload_drag_area{display:inline-block; width:60%; padding:4em 0; margin-left:.5em; border:1px dashed #ddd; color:#999; text-align:center; vertical-align:middle;}
        .upload_drag_hover{border-color:#069; box-shadow:inset 2px 2px 4px rgba(0, 0, 0, .5); color:#333;}
        .upload_preview{border-top:1px solid #bbb; border-bottom:1px solid #bbb; background-color:#fff; overflow:hidden; _zoom:1;}
        .upload_append_list{height:300px; padding:0 1em; float:left; position:relative;}
        .upload_delete{margin-left:2em;}
        .upload_image{max-height:250px; padding:5px;}
        .upload_submit{padding-top:1em; padding-left:1em;}
        .upload_submit_btn{display:none; height:32px; font-size:14px;}
        .upload_loading{height:250px; background:url('http://www.zhangxinxu.com/study/image/preload.gif') no-repeat center;}
        .upload_progress{display:none; padding:5px; border-radius:10px; color:#fff; background-color:rgba(0,0,0,.6); position:absolute; left:25px; top:45px;}
    </style>
</head>
<body>
    <div >
        <form id="uploadForm" action="upload.php" method="post" enctype="multipart/form-data">
            <div class="upload_box">
                <div class="upload_main">
                    <div class="upload_choose">
                        <input id="fileImage" type="file" size="30" name="fileselect[]" multiple />
                        <span id="fileDragArea" class="upload_drag_area">或者将图片拖到此处</span>
                    </div>
                    <div id="preview" class="upload_preview"></div>
                </div>
                <div class="upload_submit">
                    <button type="button" id="fileSubmit" class="upload_submit_btn">确认上传图片</button>
                </div>
                <div id="uploadInf" class="upload_inf"></div>
            </div>
        </form>
    </div>



</body>

<script>
    (function (window) {
        var op;
        var UploadImg = function (options) {
            var _options = {
                fileInput: null,				//html file控件
                dragDrop: null,					//拖拽敏感区域
                upButton: null,					//提交按钮
                url: "",						//ajax地址
                fileFilter: [],					//过滤后的文件数组
                filter: function(files) {		//选择文件组的过滤方法
                    return files;
                },
                onSelect: function() {},		//文件选择后
                onDelete: function() {},		//文件删除后
                onDragOver: function() {},		//文件拖拽到敏感区域时
                onDragLeave: function() {},	//文件离开到敏感区域时
                onProgress: function() {},		//文件上传进度
                onSuccess: function() {},		//文件上传成功时
                onFailure: function() {},		//文件上传失败时,
                onComplete: function() {},		//文件全部上传完毕时
            };
            for ( var key in _options){
                if(!options[key]){
                    options[key] = _options[key];
                }
            }
            op = options;
            return new UploadImg.prototype.init(options);
        };
        UploadImg.prototype.init = function (options) {
            var _self = this;
            //拖拽的实现
            if(options.dragDrop){
                options.dragDrop.addEventListener("dragover",function (e) {
                    _self.funDragHover(e);
                },false);
                options.dragDrop.addEventListener("dragleave",function (e) {
                    _self.funDragHover(e);
                },false);
                options.dragDrop.addEventListener("drop",function (e) {
                    _self.funGetFiles(e);
                },false)
            };
            //监听文件input上穿
            if(options.fileInput){
                options.fileInput.addEventListener("change",function (e) {_self.funGetFiles(e);},false);
            }
            //上传提交
            if(options.upButton) {
                options.upButton.addEventListener("click", function (e) {_self.funUploadFile(e);},false)
            }


        };
        //文件拖放
        UploadImg.prototype.funDragHover = function(e) {
            e.stopPropagation();
            e.preventDefault();
            op[e.type === "dragover"? "onDragOver": "onDragLeave"].call(e.target);
            return this;
        };
        //获取选择文件，file控件或拖放
        UploadImg.prototype.funGetFiles = function(e) {
            // 取消鼠标经过样式
            this.funDragHover(e);

            // 获取文件列表对象
            var files = e.target.files || e.dataTransfer.files;
            //继续添加文件
            op.fileFilter = op.fileFilter.concat(op.filter(files));
            this.funDealFiles();;
            return this;
        };

        //选中文件的处理与回调
        UploadImg.prototype.funDealFiles = function() {
            for (var i = 0, file; file = op.fileFilter[i]; i++) {
                //增加唯一索引值
                file.index = i;
            }
            //执行选择回调
            op.onSelect(op.fileFilter);
            return this;
        };

        //删除对应的文件
        UploadImg.prototype.funDeleteFile = function(fileDelete) {
            var arrFile = [];
            for (var i = 0, file; file = op.fileFilter[i]; i++) {
                if (file != fileDelete) {
                    arrFile.push(file);
                } else {
                    op.onDelete(fileDelete);
                }
            }
            op.fileFilter = arrFile;
            return this;
        };

        //文件上传
        UploadImg.prototype.funUploadFile =  function() {
            var self = this;
            if (location.host.indexOf("sitepointstatic") >= 0) {
                //非站点服务器上运行
                return;
            }
            for (var i = 0, file; file = this.fileFilter[i]; i++) {
                (function(file) {
                    var xhr = new XMLHttpRequest();
                    if (xhr.upload) {
                        // 上传中
                        xhr.upload.addEventListener("progress", function(e) {
                            self.onProgress(file, e.loaded, e.total);
                        }, false);

                        // 文件上传成功或是失败
                        xhr.onreadystatechange = function(e) {
                            if (xhr.readyState == 4) {
                                if (xhr.status == 200) {
                                    self.onSuccess(file, xhr.responseText);
                                    self.funDeleteFile(file);
                                    if (!self.fileFilter.length) {
                                        //全部完毕
                                        self.onComplete();
                                    }
                                } else {
                                    self.onFailure(file, xhr.responseText);
                                }
                            }
                        };

                        // 开始上传
                        xhr.open("POST", self.url, true);
                        xhr.setRequestHeader("X_FILENAME", encodeURIComponent(file.name));
                        xhr.send(file);
                    }
                })(file);
            }

        };
        UploadImg.prototype.init.prototype = UploadImg.prototype;
        window.UploadImg = UploadImg;

    })(window, undefined)

</script>
<script src="http://libs.baidu.com/jquery/1.4.4/jquery.js"></script>
<script>
    var params = {
        fileInput: document.getElementById("fileImage"),
        dragDrop: document.getElementById("fileDragArea"),
        upButton: document.getElementById("fileSubmit"),
        url: document.getElementById("uploadForm").getAttribute("action"),
        filter: function(files) {
            var arrFiles = [];
            for (var i = 0, file; file = files[i]; i++) {
                if (file.type.indexOf("image") == 0) {
                    if (file.size >= 512000) {
                        alert('您这张"'+ file.name +'"图片大小过大，应小于500k');
                    } else {
                        arrFiles.push(file);
                    }
                } else {
                    alert('文件"' + file.name + '"不是图片。');
                }
            }
            return arrFiles;
        },
        onSelect: function(files) {
            var html = '', i = 0;
            document.getElementById("preview").innerHTML = '<div class="upload_loading"></div>';
            var funAppendImage = function() {
                file = files[i];
                if (file) {
                    var reader = new FileReader()
                    reader.onload = function(e) {
                        html = html + '<div id="uploadList_'+ i +'" class="upload_append_list"><p><strong>' + file.name + '</strong>'+
                                '<a href="javascript:" class="upload_delete" title="删除" data-index="'+ i +'">删除</a><br />' +
                                '<img id="uploadImage_' + i + '" src="' + e.target.result + '" class="upload_image" /></p>'+
                                '<span id="uploadProgress_' + i + '" class="upload_progress"></span>' +
                                '</div>';

                        i++;
                        funAppendImage();
                    }
                    reader.readAsDataURL(file);
                } else {
                    document.getElementById("preview").innerHTML = html;
                    if (html) {
                        //删除方法
                        $(".upload_delete").click(function() {
                            UploadImg().funDeleteFile(files[parseInt($(this).attr("data-index"))]);
                            return false;
                        });
                        //提交按钮显示
                        $("#fileSubmit").show();
                    } else {
                        //提交按钮隐藏
                        $("#fileSubmit").hide();
                    }
                }
            };
            funAppendImage();
        }
    };
    UploadImg( params)
    </script>
</html>